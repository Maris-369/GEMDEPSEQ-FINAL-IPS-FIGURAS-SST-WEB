name: ğŸš€ Deploy to Netlify (Optimized)
on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ] # Nuevo: Trigger para tags de versiÃ³n
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  NETLIFY_CLI_VERSION: '17.10.1'
  GATSBY_CACHE_KEY: ${{ github.sha }}-${{ hashFiles('package-lock.json') }} # Cache dinÃ¡mico

jobs:
  build-and-test:
    name: ğŸ—ï¸ Build & Test (Optimized)
    runs-on: ubuntu-latest
    timeout-minutes: 15 # Nuevo: Evita builds eternos
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      # Cache mejorado (Tu cÃ³digo + mi optimizaciÃ³n)
      - name: ğŸ—ƒï¸ Cache Dependencies & Build
        uses: actions/cache@v3
        with:
          path: |
            .cache
            public
            node_modules
          key: ${{ runner.os }}-gatsby-${{ env.GATSBY_CACHE_KEY }}
          restore-keys: |
            ${{ runner.os }}-gatsby-

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci --prefer-offline --no-audit --omit=dev # MÃ¡s rÃ¡pido y seguro

      - name: ğŸ” Lint & Format Check
        run: |
          npm run format:check || echo "âš ï¸ Format check skipped"
          npm run lint || echo "âš ï¸ Lint check skipped"
        continue-on-error: true

      - name: ğŸ—ï¸ Build Project
        run: npm run build
        env:
          NODE_ENV: production
          CI: true
          GATSBY_SITE_URL: ${{ secrets.GATSBY_SITE_URL }}
          GATSBY_WEATHER_API_KEY: ${{ secrets.GATSBY_WEATHER_API_KEY }}
          GATSBY_GOOGLE_ANALYTICS_ID: ${{ secrets.GATSBY_GOOGLE_ANALYTICS_ID }}

      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: public/
          retention-days: 7

  deploy:
    name: ğŸŒ Deploy to Netlify
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: public/

      # Deploy con verificaciÃ³n de errores
      - name: ğŸš€ Deploy to Netlify
        id: netlify-deploy
        uses: netlify/actions/cli@master
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        with:
          args: deploy --dir=public --prod --message "Deploy [SKIP CI] - ${{ github.sha }}"

      - name: âœ… Verify Deployment
        if: steps.netlify-deploy.outcome != 'success'
        run: |
          echo "âŒ Fallo en el deploy!"
          exit 1

  preview-deploy:
    name: ğŸ‘€ Preview Deploy
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'pull_request'
    timeout-minutes: 10 # Nuevo: Timeout especÃ­fico para previews
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: public/

      - name: ğŸ” Deploy Preview
        uses: netlify/actions/cli@master
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        with:
          args: deploy --dir=public --message "Preview PR #${{ github.event.number }}"

      - name: ğŸ’¬ Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸŒ **Preview IPS Figuras CÃºcuta**\nğŸ”— [Ver Demo](${{ steps.netlify-deploy.outputs.site_url }})\nğŸ“Œ Commit: ${process.env.GITHUB_SHA.slice(0,7)}`
            })

  lighthouse:
    name: ğŸ” Lighthouse Audit
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ” Run Lighthouse
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            ${{ secrets.GATSBY_SITE_URL }}
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: ./lighthouserc.json # Archivo de configuraciÃ³n personalizado

  notify:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [deploy, lighthouse]
    if: always()
    
    steps:
      - name: Slack Notification
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: danger
          SLACK_TITLE: "ğŸš¨ Fallo en IPS Figuras CÃºcuta"
          SLACK_MESSAGE: "Error en ${{ github.workflow }} (Commit: ${{ github.sha }})"